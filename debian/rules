#!/usr/bin/make -f
# debian.rules file for tem-vserver
# Copyright 2012 Paul Slootman <paul@debian.org>
# Based on the  sample debian.rules file - for GNU Hello (1.3).
#   Copyright 1994,1995 by Ian Jackson.
# I hereby give you perpetual unlimited permission to copy,
# modify and relicense this file, provided that you do not remove
# my name from the file itself.  (I assert my moral right of
# paternity under the Copyright, Designs and Patents Act 1988.)


INSTALL = install
INSTALL_FILE    = $(INSTALL) -p    -o root -g root  -m  644
INSTALL_PROGRAM = $(INSTALL) -p    -o root -g root  -m  755
INSTALL_SCRIPT  = $(INSTALL) -p    -o root -g root  -m  755
INSTALL_DIR     = $(INSTALL) -p -d -o root -g root  -m  755

build:
# nothing to do

clean: checkdir
	-rm -f build
	-rm -rf *~ debian/*~ debian/*.bak debian/files* debian/substvars
	-rm -rf debian/tem-vserver*

binary-indep:	checkroot build
	$(INSTALL_DIR)	debian/tem-vserver/DEBIAN \
			debian/tem-vserver/usr/share/doc/tem-vserver \
			debian/tem-vserver/usr/local/sbin \
			debian/tem-vserver/usr/local/lib/site_perl
	$(INSTALL_FILE)	debian/changelog debian/tem-vserver/usr/share/doc/tem-vserver/changelog.Debian
	# $(INSTALL_FILE)	README       debian/tem-vserver/usr/share/doc/tem-vserver/README
	$(INSTALL_FILE) debian/copyright debian/tem-vserver/usr/share/doc/tem-vserver/copyright
	$(INSTALL_SCRIPT) debian/postinst debian/postrm debian/tem-vserver/DEBIAN

	# Scripts manager
	$(INSTALL_DIR) debian/tem-vserver/usr/lib/tem-vserver/scripts \
		debian/tem-vserver/usr/lib/tem-vserver/ \
		debian/tem-vserver/root/vserver/scripts \
		debian/tem-vserver/usr/share/lua/5.1/ \
		debian/tem-vserver/usr/share/lua/5.2/ \
		debian/tem-vserver/usr/share/lua/5.1/tem/ \
		debian/tem-vserver/usr/share/lua/5.2/tem/ \
		debian/tem-vserver/root/vserver/lib
	$(INSTALL_FILE) tem-scripts/scripts/* debian/tem-vserver/usr/lib/tem-vserver/scripts
	$(INSTALL_SCRIPT) tem-scripts/sbin/* debian/tem-vserver/usr/local/sbin
	$(INSTALL_FILE) tem-scripts/lib/* debian/tem-vserver/usr/share/lua/5.1/tem
	$(INSTALL_FILE) tem-scripts/lib/* debian/tem-vserver/usr/share/lua/5.2/tem
	$(INSTALL_FILE) tem-scripts/lua/* debian/tem-vserver/usr/share/lua/5.1
	$(INSTALL_FILE) tem-scripts/lua/* debian/tem-vserver/usr/share/lua/5.2
	dh_lua
	$(INSTALL_SCRIPT) sizing/vserver-config-size.pl debian/tem-vserver/usr/local/sbin
	$(INSTALL_FILE) sizing/sizing.pm debian/tem-vserver/usr/local/lib/site_perl
	$(INSTALL_SCRIPT) build-scripts/vserver/build-template.sh  debian/tem-vserver/usr/local/sbin
	$(INSTALL_SCRIPT) build-scripts/vserver/build-vserver.sh   debian/tem-vserver/usr/local/sbin
	$(INSTALL_SCRIPT) build-scripts/vserver/build-vlan-vserver debian/tem-vserver/usr/local/sbin
	chmod 700 debian/tem-vserver/root
	dpkg-gencontrol -ptem-vserver -Pdebian/tem-vserver
	chown -R root.root debian/tem-vserver
	chmod -R go=rX debian/tem-vserver
	dpkg --build debian/tem-vserver ..

binary-arch:	checkroot build
# nothing to do

# Below here is fairly generic really

binary:		binary-indep binary-arch

checkdir:
	@test -f debian/rules

checkroot: checkdir
	@test 0 = `id -u` || { echo "Error: not super-user"; exit 1; }

.PHONY: binary binary-arch binary-indep clean checkroot checkdir
